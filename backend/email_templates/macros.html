{# Macro to render attendees (both dignitaries and contacts) #}
{% macro render_attendees(appointment, format='list') %}
    {% set attendees = [] %}
    
    {# Collect dignitaries #}
    {% if appointment.appointment_dignitaries %}
        {% for app_dignitary in appointment.appointment_dignitaries %}
            {% set dignitary = app_dignitary.dignitary %}
            {% set attendee_name = dignitary.honorific_title|format_honorific_title + " " + dignitary.first_name + " " + dignitary.last_name %}
            {% set _ = attendees.append({'name': attendee_name.strip(), 'type': 'dignitary'}) %}
        {% endfor %}
    {% elif appointment.dignitary %}
        {% set attendee_name = appointment.dignitary.honorific_title|format_honorific_title + " " + appointment.dignitary.first_name + " " + appointment.dignitary.last_name %}
        {% set _ = attendees.append({'name': attendee_name.strip(), 'type': 'dignitary'}) %}
    {% endif %}
    
    {# Collect contacts #}
    {% if appointment.appointment_contacts %}
        {% for app_contact in appointment.appointment_contacts %}
            {% set contact = app_contact.contact %}
            {% if contact.relationship_to_owner == "Self" or (contact.first_name == "Self" and contact.last_name == "Self") %}
                {% set attendee_name = "Self" %}
            {% else %}
                {% set attendee_name = contact.first_name + " " + contact.last_name %}
            {% endif %}
            {% set relationship = contact.relationship_to_owner %}
            {% set _ = attendees.append({'name': attendee_name.strip(), 'type': 'contact', 'relationship': relationship}) %}
        {% endfor %}
    {% endif %}
    
    {# Render based on format #}
    {% if format == 'list' %}
        {% if attendees %}
            <ul>
            {% for attendee in attendees %}
                <li>{{ attendee.name }}{% if attendee.type == 'contact' and attendee.relationship %} ({{ attendee.relationship }}){% endif %}</li>
            {% endfor %}
            </ul>
        {% else %}
            <p>No attendees assigned</p>
        {% endif %}
    {% elif format == 'inline' %}
        {% if attendees %}
            {% for attendee in attendees %}
                {{ attendee.name }}{% if not loop.last %}{% if loop.index == attendees|length - 1 %} and {% else %}, {% endif %}{% endif %}
            {% endfor %}
            {% if attendees|length > 1 %} (Group of {{ attendees|length }}){% endif %}
        {% else %}
            No attendees assigned
        {% endif %}
    {% elif format == 'separated' %}
        {% set dignitaries = attendees|selectattr('type', 'equalto', 'dignitary')|list %}
        {% set contacts = attendees|selectattr('type', 'equalto', 'contact')|list %}
        
        {% if dignitaries %}
            <p><strong>Dignitaries:</strong> {{ dignitaries|map(attribute='name')|join(', ') }}</p>
        {% endif %}
        {% if contacts %}
            <p><strong>Contacts:</strong> {{ contacts|map(attribute='name')|join(', ') }}</p>
        {% endif %}
        {% if not dignitaries and not contacts %}
            <p>No attendees assigned</p>
        {% endif %}
    {% endif %}
{% endmacro %}

{# Macro to get total attendee count #}
{% macro attendee_count(appointment) %}
    {{ ((appointment.appointment_dignitaries or []) | length) + ((appointment.appointment_contacts or []) | length) }}
{% endmacro %}

{# Macro to format appointment dates (handles both single dates and date ranges) #}
{% macro format_appointment_date(appointment, include_time=true) %}
    {% if appointment.appointment_date %}
        {# Confirmed appointment date #}
        {{ appointment.appointment_date }}{% if include_time and appointment.appointment_time %} {{ appointment.appointment_time }}{% endif %}
    {% elif appointment.preferred_start_date and appointment.preferred_end_date %}
        {# Date range for non-dignitary appointments #}
        {% if appointment.preferred_start_date == appointment.preferred_end_date %}
            {{ appointment.preferred_start_date }}{% if include_time and appointment.preferred_time_of_day %} {{ appointment.preferred_time_of_day }}{% endif %}
        {% else %}
            {{ appointment.preferred_start_date }} - {{ appointment.preferred_end_date }}{% if include_time and appointment.preferred_time_of_day %} ({{ appointment.preferred_time_of_day }}){% endif %}
        {% endif %}
    {% elif appointment.preferred_date %}
        {# Single preferred date for dignitary appointments #}
        {{ appointment.preferred_date }}{% if include_time and appointment.preferred_time_of_day %} {{ appointment.preferred_time_of_day }}{% endif %}
    {% else %}
        To be determined
    {% endif %}
{% endmacro %}

{# Macro to get date type label for display #}
{% macro get_date_label(appointment) %}
    {% if appointment.appointment_date %}
        Confirmed Date & Time
    {% elif appointment.preferred_start_date and appointment.preferred_end_date %}
        {% if appointment.preferred_start_date == appointment.preferred_end_date %}
            Requested Date
        {% else %}
            Requested Date Range
        {% endif %}
    {% elif appointment.preferred_date %}
        Requested Date
    {% else %}
        Date & Time
    {% endif %}
{% endmacro %} 